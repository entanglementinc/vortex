#!/bin/bash
FREQ=3100000000
TMPSIZE=104857600
function test()
{
	name=$1
	our_exe=$2
	ref_exe=$3
	art_cpb=$4
	security=$5
	isStream=$6
	
	if [ -z $isStream ]
	then
		our_ret=`(time bin/$our_exe tmp) 2>&1`
	else
		our_ret=`(time bin/$our_exe tmpkey tmp > /dev/null) 2>&1`
	fi
	our_cpb=$(echo $our_ret | grep -Eo "user\s*[0-9]+m[0-9]+\.[0-9]+s" | sed "s/user\s*\([0-9]*\)m\([0-9]*\.[0-9]*\)s/scale=2;(\1*60+\2) * $FREQ \/ $TMPSIZE/g" | bc | awk '{printf "%.2f", $1}')
	
	if [ ! -z "$art_cpb" ]
	then
		art_ratio=$(echo $our_cpb $art_cpb | awk '{printf "%.2f", $1 / $2}')
	else
		art_cpb="-"
		art_ratio="-"
	fi
	
	if [ ! -z "$ref_exe" ]
	then
		if [ -z $isStream ]
		then
			ref_ret=`(time ref/$ref_exe tmp) 2>&1`
		else
			ref_ret=`(time ref/$ref_exe tmp > /dev/null) 2>&1`
		fi
		
		ref_cpb=$(echo $ref_ret | grep -Eo "user\s*[0-9]+m[0-9]+\.[0-9]+s" | sed "s/user\s*\([0-9]*\)m\([0-9]*\.[0-9]*\)s/scale=2;(\1*60+\2) * $FREQ \/ $TMPSIZE/g" | bc | awk '{printf "%.2f", $1}')
		ref_ratio=$(echo $our_cpb $ref_cpb | awk '{printf "%.2f", $1 / $2}')
		
		if [ -z $isStream ]
		then
			our_res=$(echo $our_ret | grep -Eo "^\S*\s*\S*")
			ref_res=$(echo $ref_ret | grep -Eo "^\S*\s*\S*")
			if [ "$our_res" != "$ref_res" ]
			then
				our_cpb="X"
				ref_ratio="X"
				art_ratio="X"
			fi
		fi
	else
		ref_cpb="-"
		ref_ratio="-"
	fi
	
	printf "% -11s" "$name"
	printf "% -8s"  "$art_cpb"
	printf "% -8s"  "$ref_cpb"
	printf "% -8s"  "$our_cpb"
	printf "% -9s"  "$art_ratio"
	printf "% -9s"  "$ref_ratio"
	printf "% -9s"  "$security"
	echo ""
}

(
echo "Generating random files..."
dd if=/dev/urandom of=tmpkey count=1 2> /dev/null
dd if=/dev/urandom of=tmp    count=$(($TMPSIZE/512)) 2> /dev/null

echo "Benching..."
) >&2

if [ $TMPSIZE -ge 1073741824 ]; then
	HSIZE="$(echo "scale=1;$TMPSIZE / 1073741842" | bc)GB"
elif [ $TMPSIZE -ge 1048576 ]; then
	HSIZE="$(echo "scale=1;$TMPSIZE / 1048576" | bc)MB"
elif [Â $TMPSIZE -ge 1024 ]; then
	HSIZE="$(echo "scale=1;$TMPSIZE / 1024" | bc)kB"
else
	HSIZE="${TMPSIZE}B"
fi
if [ $FREQ -ge 1000000000 ]; then
	HFREQ="$(echo "scale=1;$FREQ / 1000000000" | bc)GHz"
elif [ $FREQ -ge 1000000 ]; then
	HFREQ="$(echo "scale=1;$FREQ / 1000000" | bc)MHz"
elif [ $FREQ -ge 1000 ]; then
	HFREQ="$(echo "scale=1;$FREQ / 1000" | bc)kHz"
else
	HFREQ="${FREQ}Hz"
fi

echo "=== Tests with $HSIZE on a $HFREQ CPU ==="
echo "           art     ref     our     our/art  our/ref  security "

test "FSB-160"   "fsb160"  "FSB/fsb -s 160"   "257"   "100"
test "FSB-224"   "fsb224"  "FSB/fsb -s 224"   "297"   "135"
test "FSB-256"   "fsb256"  "FSB/fsb -s 256"   "324"   "153"
test "FSB-384"   "fsb384"  "FSB/fsb -s 384"   "423"   "215"
test "FSB-512"   "fsb512"  "FSB/fsb -s 512"   "507"   "285"
test "SFSB-160"  "sfsb160" "SFSB/sfsb -s 160" "160"   "86"
test "SFSB-224"  "sfsb224" "SFSB/sfsb -s 224" "201"   "114"
test "SFSB-384"  "sfsb384" "SFSB/sfsb -s 384" "183"   "129"
test "RFSB-509"  "rfsb"    "RFSB/rfsb"        "13.62" "142"

test "SYND-64"   "synd64"   ""                              "22"    "71"  "yes"
test "SYND-96"   "synd96"   ""                              "46"    "102" "yes"
test "SYND-128"  "synd128"  "SYND/synd -k tmpkey -s 83 -i"  "27"    "131" "yes"
test "SYND-192"  "synd192"  ""                              "47"    "191" "yes"
test "SYND-256"  "synd256"  "SYND/synd -k tmpkey -s 170 -i" "53"    "252" "yes"
test "SYND-512"  "synd512"  "SYND/synd -k tmpkey -s 366 -i" "83"    "493"  "yes"
test "2SC-144"   "2sc144"   "2SC/2sc -k tmpkey -s 100 -i"   "37"    "80"  "yes"
test "2SC-208"   "2sc208"   "2SC/2sc -k tmpkey -s 200 -i"   "47"    "170" "yes"
test "2SC-352"   "2sc352"   "2SC/2sc -k tmpkey -s 350 -i"   "72"    "366" "yes"
test "XSYND-509" "xsynd"    ""                              ""      ""    "yes"

rm tmp
rm tmpkey
